<canvas id="canvas2" width="100" height="100" style="image-rendering: pixelated;"></canvas>

<script>

const DELAY = 300
    function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function max0(x) {
        return Math.max(0, x)
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    var canvas2 = document.getElementById('canvas2');
    var ctx2 = canvas2.getContext('2d');
    ctx2.fillStyle = "#000000"
    ctx2.fillRect(0, 0, 100, 100)

    let algae = []
    let blob = [
        {
            x: 30,
            y: 30,
            e: 5,
            d: 0
        }
    ]

    var im = ctx2.createImageData(1,1); // only do this once per page
    var d  = im.data;                        // only do this once per page
    d[0]   = 0;
    d[1]   = 250;
    d[2]   = 0;
    d[3]   = 250;
    async function render() {
        ctx2.clearRect(0,0,100,100)
        ctx2.fillStyle = "#000000"
        ctx2.fillRect(0, 0, 100, 100)
        algae.forEach(a => {
            ctx2.putImageData( im, a[0], a[1] );  
        })
        blob.forEach(b => {
            ctx2.beginPath()
            ctx2.arc(b.x, b.y, b.e, 0, Math.PI * 2);
            ctx2.fillStyle = "#B000FF"
            ctx2.fill();
        })
    }

    function dist(b, a) {
        let dx = b.x - a[0]
        let dy = b.y - a[1]
        let c2 = dx*dx + dy*dy
        return Math.sqrt(c2)
    }
    async function move() {
        algae.forEach(a => {
            let r = Math.random()
            if (r < 0.5) {
                return
            }
            if (r < 0.625) { //move left
                a[0] = Math.max(0, a[0]-1)
                return
            }
            if (r < 0.75) { //move right
                a[0] = Math.min(99, a[0]+1)
                return
            }
            if (r < 0.875) { //move up
                a[1] = Math.max(0, a[1]-1)
                return
            }
            if (r < 0.99) { //move down
                a[1] = Math.min(99, a[1]+1)
                return
            }
            
        })

        blob.forEach(b => {
            if (Math.random() < 0.25) {
                b.d += 0.1*Math.PI
            }
            let dx = Math.cos(b.d)
            let dy = Math.sin(b.d)
            b.x += dx
            b.y += dy
            b.x = Math.max(0, b.x)
            b.x = Math.min(99, b.x)
            b.y = Math.max(0, b.y)
            b.y = Math.min(99, b.y)
        })
    }

    async function eat() {
        blob.forEach(b => {
            algae.forEach(a => {
                if (dist(b, a) < b.e) {
                    b.e++
                    a[0] = -50  //temp move outside of world, cleanup later
                    a[1] = -50
                    console.log("blob ate algae")
                }
            })
        })
    }

    async function cleanup() {
        algae = algae.filter(a => a[0] != -50)
    }

    async function hej() {
        await sleep(DELAY)
        if (algae.length < 50) {
            let xstart = randInt(0, 99)
            let ystart = randInt(0, 99)
            let newalg = [xstart, ystart]
            algae.push(newalg)
        }
        
        await move()
        
        await eat()
        await cleanup()
        await render()

        
        
    }

    async function start() {
        while(true) {
            
            await hej()
            
        }
    }
    
    start()

</script>
